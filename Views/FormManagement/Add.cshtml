@model EquipCheck.Models.ViewModels.VM_Form
@{
    ViewData["Title"] = "問卷編輯";
    Layout = "_Layout";
}

<h2 class="mb-3">表單編輯</h2>

<form method="post" id="checklistForm">
    @Html.HiddenFor(m => m.FormUID)
    @Html.HiddenFor(m => m.Sort)
    @Html.HiddenFor(m => m.Status)

    <div class="row g-2 mb-3">
        <div class="col-auto">
            <label class="col-form-label">表單名稱：</label>
        </div>
        <div class="col-6 col-md-4">
            @Html.TextBoxFor(m => m.FormName, new { @class = "form-control" })
        </div>
        <div class="col-auto">
            <label class="col-form-label">年份：</label>
        </div>
        <div class="col-2">
            @Html.TextBoxFor(m => m.Year, new { @class = "form-control", type = "number", min = "1", max = "8088" })
        </div>
    </div>
    <div class="row g-2 mb-3">
        <div class="col-auto">
            <label class="col-form-label">發起人：</label>
        </div>
        <div class="col-auto">
            @Html.DropDownListFor(m => m.Sponsor, new SelectList(Model.SponsorDDL, "Value", "Text"), "請選擇發起人", new { @class = "form-select" })
        </div>
        <div class="col-auto">
            <label class="col-form-label">填寫時間：</label>
        </div>
        <div class="col-auto">
            @Html.TextBoxFor(m => m.StartDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
        </div>
        <div class="col-auto">
            <label class="col-form-label">～</label>
        </div>
        <div class="col-auto">
            @Html.TextBoxFor(m => m.EndDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
        </div>
        <div class="col-auto ms-auto">
            <button type="button" class="btn btn-secondary" onclick="history.back()">
                <i class="bi bi-arrow-left me-1"></i>返回
            </button>
            <button type="button" id="btnAdd" class="btn btn-primary">＋ 新增題目</button>
            <button type="submit" class="btn btn-success">儲存</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered align-middle" id="itemsTable">
            <thead class="table-light">
                <tr>
                    <th style="width:50px;">#</th>
                    <th>檢查項目</th>
                    <th style="width:140px;">是否啟用</th>
                    <th style="width:90px;">操作</th>
                </tr>
            </thead>
            <tbody id="itemsBody">
                @if (Model.Items != null)
                {
                    for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <td class="text-center">@(i + 1)</td>
                            <td>
                                @Html.HiddenFor(m => m.Items[i].ChecklistItemUid)
                                @Html.HiddenFor(m => m.Items[i].Sort)
                                @Html.TextBoxFor(m => m.Items[i].ItemName, new { @class = "form-control item-name" })
                            </td>
                            <td class="text-center">
                                @Html.CheckBoxFor(m => m.Items[i].Status, new { @class = "form-check-input item-status" })
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete">刪除</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</form>

<template id="rowTemplate">
    <tr>
        <td class="text-center index-cell"></td>
        <td>
            <input type="hidden" name="Items[IDX].ChecklistItemUid" class="item-checklistItemUid" />
            @* <input type="hidden" name="Items[IDX].FormUID" class="item-formUid" /> *@
            <input type="hidden" name="Items[IDX].Sort" class="item-sort" value="0" />
            <input type="text" name="Items[IDX].ItemName" class="form-control item-name" placeholder="請輸入檢查項目..." />
        </td>
        <td class="text-center">
            <input type="checkbox" name="Items[IDX].Status" class="form-check-input item-status" checked />
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger btn-delete">刪除</button>
        </td>
    </tr>
</template>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(function() {
            const $body = $('#itemsBody');
            const $btnAdd = $('#btnAdd');
            const $tpl = $('#rowTemplate').html();
            const $form = $('#checklistForm');
            const $formUid = $('#FormUID');

            // 產生新guid
            function newGuid() {
                if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // 新增題目
            $btnAdd.on('click', function() {
                const currentIndex = $body.find('tr').length;
                const newRow = $tpl.replace(/IDX/g, currentIndex);
                var $tr = $(newRow);

                $tr.find('.item-checklistItemUid').val(newGuid());
                // $tr.find('.item-formUid').val($formUid.val() || '');
                $tr.find('.index-cell').text(currentIndex + 1);
                $body.append($tr);
                reindex();
            });

            // 刪除題目
            $body.on('click', '.btn-delete', function() {
                $(this).closest('tr').remove();
                reindex();
            });

            // 重新編號並更新 name 屬性
            function reindex() {
                $body.find('tr').each(function(i) {
                    const $tr = $(this);
                    $tr.find('.index-cell').text(i + 1);
                    $tr.find('input').each(function() {
                        const $input = $(this);
                        const name = $input.attr('name');
                        if (name) {
                            $input.attr('name', name.replace(/Items\[\d+\]/, `Items[${i}]`));
                        }
                    });
                    $tr.find('.item-sort').val(i + 1);
                    // $tr.find('.item-formUid').val($formUid.val() || '');
                });
            }


            // 表單提交
            $form.on('submit', function(e) {
                e.preventDefault();

                if (!validateForm()) {
                    return false;
                }

                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: response.message,
                                text: '表單已成功創建',
                                allowOutsideClick: false
                            }).then((response) => {
                                if (response.isConfirmed) {
                                    window.location.href = '@Url.Action("List", "FormManagement")';
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '錯誤',
                                text: response.message || '儲存失敗，請稍後再試'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: '錯誤',
                            text: '系統發生錯誤，請稍後再試'
                        });
                    }
                });
            });

            // 表單驗證
            function validateForm() {
                const formName = $('#FormName').val().trim();
                const year = $('#Year').val();
                const sponsor = $('#Sponsor').val();
                const startDate = $('#StartDate').val();
                const endDate = $('#EndDate').val();

                if (!formName) {
                    Swal.fire('錯誤', '請輸入表單名稱', 'error');
                    return false;
                }

                if (!year) {
                    Swal.fire('錯誤', '請輸入年份', 'error');
                    return false;
                }

                if (!sponsor) {
                    Swal.fire('錯誤', '請選擇發起人', 'error');
                    return false;
                }

                if (!startDate || !endDate) {
                    Swal.fire('錯誤', '請設定填寫時間區間', 'error');
                    return false;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    Swal.fire('錯誤', '結束日期不能早於開始日期', 'error');
                    return false;
                }

                const items = $body.find('.item-name').map(function() {
                    return $(this).val().trim();
                }).get();

                if (items.length === 0) {
                    Swal.fire('錯誤', '請至少新增一個檢查項目', 'error');
                    return false;
                }

                if (items.some(item => !item)) {
                    Swal.fire('錯誤', '檢查項目名稱不能為空', 'error');
                    return false;
                }

                return true;
            }
        });
    </script>
}